<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh to√°n D-Cine</title>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* CSS GIAO DI·ªÜN */
        :root { --primary: #e50914; --bg: #111; --card: #1f1f1f; --text: #fff; --text-sub: #aaa; }
        body { margin: 0; padding: 20px; font-family: 'Be Vietnam Pro', sans-serif; background-color: var(--bg); color: var(--text); padding-top: 60px; }
        .container { max-width: 480px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h2 { color: var(--primary); font-size: 24px; text-transform: uppercase; margin: 0; }
        .card { background-color: var(--card); border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .info-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 14px; border-bottom: 1px solid #333; padding-bottom: 8px; }
        .info-row:last-child { border-bottom: none; margin-bottom: 0; }
        .label { color: var(--text-sub); }
        .value { font-weight: 500; text-align: right; max-width: 60%; }
        .total-row { display: flex; justify-content: space-between; margin-top: 15px; padding-top: 15px; border-top: 1px solid #333; font-size: 18px; font-weight: 700; color: var(--primary); }
        .btn-pay { width: 100%; background-color: var(--primary); color: white; border: none; padding: 16px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; text-transform: uppercase; transition: transform 0.2s; }
        .btn-pay:active { transform: scale(0.98); }
        .btn-pay:disabled { background-color: #555; cursor: not-allowed; }
        
        /* CSS CHO H·ªòP DEBUG (B√ÅO L·ªñI) */
        #debug-box {
            position: fixed; top: 0; left: 0; width: 100%; z-index: 9999;
            background: rgba(255, 255, 255, 0.95); color: #000;
            font-size: 13px; max-height: 250px; overflow-y: auto;
            border-bottom: 3px solid red; box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        .log-item { padding: 4px 10px; border-bottom: 1px solid #ddd; font-family: monospace; }
        .log-err { color: red; font-weight: bold; background: #ffeeee; }
        .log-info { color: blue; }
        .log-ok { color: green; font-weight: bold; }
    </style>
</head>
<body>

    <div id="debug-box">
        <div class="log-item log-info">üöÄ ƒêang kh·ªüi ƒë·ªông trang web...</div>
    </div>

    <div class="container">
        <div class="header">
            <h2>X√°c nh·∫≠n thanh to√°n</h2>
        </div>

        <div class="card">
            <div class="info-row"><span class="label">M√£ ƒë∆°n h√†ng:</span><span class="value" id="orderId">...</span></div>
            <div class="info-row"><span class="label">Phim:</span><span class="value" id="movieName">...</span></div>
            <div class="info-row"><span class="label">R·∫°p:</span><span class="value" id="theaterName">...</span></div>
            <div class="info-row"><span class="label">Ng√†y chi·∫øu:</span><span class="value" id="showDate">...</span></div>
            <div class="info-row"><span class="label">Su·∫•t chi·∫øu:</span><span class="value" id="showTime">...</span></div>
            <div class="info-row"><span class="label">Gh·∫ø:</span><span class="value" id="seats">...</span></div>
        </div>

        <div class="card">
            <div class="info-row"><span class="label">Ti·ªÅn v√©:</span><span class="value" id="ticketPrice">0ƒë</span></div>
            <div class="info-row"><span class="label">Combo:</span><span class="value" id="comboPrice">0ƒë</span></div>
            <div class="total-row"><span>T·ªîNG TI·ªÄN:</span><span id="totalPrice">0ƒë</span></div>
        </div>

        <button class="btn-pay" id="btnPay">X√ÅC NH·∫¨N THANH TO√ÅN</button>
    </div>

    <script>
        // ===========================================
        // C·∫§U H√åNH IP (B·∫†N S·ª¨A IP ·ªû ƒê√ÇY N·∫æU C·∫¶N)
        // ===========================================
        const SERVER_IP = "192.168.1.11"; 
        const SERVER_PORT = "8080";
        // ===========================================

        const BASE_URL = `http://${SERVER_IP}:${SERVER_PORT}`;

        // H√ÄM GHI LOG RA M√ÄN H√åNH
        function log(msg, type = 'info') {
            const box = document.getElementById('debug-box');
            const div = document.createElement('div');
            div.className = 'log-item log-' + type;
            div.textContent = (type === 'err' ? '‚ùå ' : (type === 'ok' ? '‚úÖ ' : '‚ÑπÔ∏è ')) + msg;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight; // T·ª± cu·ªôn xu·ªëng d∆∞·ªõi
        }

        window.onerror = function(msg, url, line) {
            log(`L·ªói JS (D√≤ng ${line}): ${msg}`, 'err');
        };

        const $ = document.querySelector.bind(document);
        const toVND = (n) => (Number(n) || 0).toLocaleString('vi-VN') + 'ƒë';

        // L·∫•y Transaction ID
        const urlParams = new URLSearchParams(window.location.search);
        const transId = urlParams.get('trans');

        async function init() {
            log(`IP Server ƒëang d√πng: ${SERVER_IP}`);
            
            if (!transId) {
                log("L·ªói: URL thi·∫øu m√£ trans!", 'err');
                return;
            }

            log(`ƒêang t·∫£i ƒë∆°n: ${transId}...`);
            const apiUrl = `${BASE_URL}/api/checkout/order?trans=${transId}`;

            try {
                // G·ªçi API
                const res = await fetch(apiUrl).catch(e => {
                    throw new Error("Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c t·ªõi " + SERVER_IP);
                });

                log(`Server ph·∫£n h·ªìi: ${res.status}`);

                if (!res.ok) throw new Error(`L·ªói API (${res.status})`);

                const data = await res.json();
                log("ƒê√£ nh·∫≠n d·ªØ li·ªáu JSON!", 'ok');
                renderData(data);

            } catch (e) {
                log(e.message, 'err');
                $('#movieName').textContent = "M·∫•t k·∫øt n·ªëi";
            }
        }

        function renderData(data) {
            try {
                $('#orderId').textContent = data.orderId || '...';
                
                // V√©
                const t = data.ticket || {};
                $('#movieName').textContent = t.movieTitle || '...';
                $('#theaterName').textContent = t.theaterName || '...';
                $('#showDate').textContent = t.date || '--';
                $('#showTime').textContent = t.time || '--';
                const s = t.seats || [];
                $('#seats').textContent = s.length ? s.join(', ') : 'Ch∆∞a ch·ªçn';

                // Ti·ªÅn
                const m = data.totals || {};
                $('#ticketPrice').textContent = toVND(m.ticketAmount);
                $('#comboPrice').textContent = toVND(m.combosAmount);
                $('#totalPrice').textContent = toVND(m.grandTotal);

                // G√°n s·ª± ki·ªán n√∫t b·∫•m sau khi ƒë√£ load xong
                $('#btnPay').onclick = handlePayment;
                
            } catch (e) {
                log("L·ªói hi·ªÉn th·ªã: " + e.message, 'err');
            }
        }

        async function handlePayment() {
            const btn = $('#btnPay');
            btn.disabled = true;
            btn.textContent = "ƒêANG G·ª¨I...";
            log("ƒêang x√°c nh·∫≠n thanh to√°n...");

            try {
                const url = `${BASE_URL}/api/checkout/mark-paid?trans=${transId}`;
                const res = await fetch(url, { method: 'POST' });

                if (res.ok) {
                    log("Thanh to√°n TH√ÄNH C√îNG!", 'ok');
                    alert("‚úÖ THANH TO√ÅN TH√ÄNH C√îNG!");
                    document.body.innerHTML = `
                        <div style="text-align:center;padding:50px;color:white;">
                            <h1>‚úÖ XONG!</h1><p>Ki·ªÉm tra m√°y t√≠nh.</p>
                        </div>
                    `;
                } else {
                    throw new Error("L·ªói x√°c nh·∫≠n: " + res.status);
                }
            } catch (e) {
                log(e.message, 'err');
                alert("L·ªói: " + e.message);
                btn.disabled = false;
                btn.textContent = "TH·ª¨ L·∫†I";
            }
        }
        init();
    </script>
</body>
</html>
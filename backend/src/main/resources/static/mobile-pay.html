<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>D-CINE | Xác nhận thanh toán</title>
  <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root { --primary: #e50914; --bg: #111; --card-bg: #1f1f1f; --text: #fff; --text-sub: #aaa; }
    body {
      margin: 0; padding: 20px;
      font-family: 'Be Vietnam Pro', sans-serif;
      background: var(--bg); color: var(--text);
      padding-top: 20px;
    }

    .wrap {
      max-width: 480px; margin: auto;
      background: var(--card-bg); padding: 20px;
      border-radius: 12px; border: 1px solid #333;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }

    h2 {
      text-align: center; margin-bottom: 25px;
      color: var(--primary); text-transform: uppercase;
      font-size: 20px; letter-spacing: 1px;
    }

    .info-box {
      background: #2b2b2b; padding: 15px;
      border-radius: 10px; margin-bottom: 20px;
      border: 1px solid #333;
    }

    .row {
      display: flex; justify-content: space-between; align-items: flex-start;
      margin: 10px 0; font-size: 14px; line-height: 1.4;
    }

    .label { color: var(--text-sub); width: 100px; flex-shrink: 0; }
    .value {
      flex: 1; text-align: right; color: #fff; font-weight: 500;
      word-break: break-word;
    }

    /* Highlight tên phim & rạp */
    #movieTitle { color: #fff; font-weight: 700; font-size: 15px; text-transform: uppercase; }
    #theaterName { color: #ccc; font-weight: 600; }

    .divider { border: 0; border-top: 1px dashed #555; margin: 15px 0; }

    .total-row {
      display: flex; justify-content: space-between;
      margin-top: 10px; font-size: 18px; font-weight: 700; color: var(--primary);
    }

    .btn {
      width: 100%; padding: 16px;
      background: var(--primary); border: none; border-radius: 8px;
      font-size: 16px; font-weight: bold; color: #fff;
      cursor: pointer; text-transform: uppercase; transition: transform 0.1s;
    }
    .btn:active { transform: scale(0.98); background: #c21c20; }
    .btn:disabled { background: #555; cursor: not-allowed; }

    /* Hộp báo lỗi (Debug) */
    #debug-box {
        position: fixed; top: 0; left: 0; width: 100%; z-index: 9999;
        background: #fff; color: #000; font-size: 12px;
        max-height: 200px; overflow-y: auto; display: none; /* Ẩn mặc định */
        border-bottom: 2px solid red; padding: 5px;
    }
    .log-err { color: red; font-weight: bold; }
    .log-ok { color: green; }

    .success-msg {
        text-align: center; color: #4caf50; font-size: 18px; 
        font-weight: bold; margin-top: 20px; display: none;
    }
  </style>
</head>

<body>
  <div id="debug-box"></div>

  <div class="wrap" id="mainContent">
    <h2>XÁC NHẬN THANH TOÁN</h2>

    <div class="info-box">
      <div class="row"><span class="label">Mã đơn:</span><span class="value" id="orderId">...</span></div>
      <div class="row"><span class="label">Phim:</span><span class="value" id="movieTitle">...</span></div>
      <div class="row"><span class="label">Rạp:</span><span class="value" id="theaterName">...</span></div>
      <div class="row"><span class="label">Ngày:</span><span class="value" id="showDate">...</span></div>
      <div class="row"><span class="label">Suất:</span><span class="value" id="showTime">...</span></div>
      <div class="row"><span class="label">Ghế:</span><span class="value" id="seatList">...</span></div>
    </div>

    <div class="info-box">
      <div class="row"><span class="label">Tiền vé:</span><span class="value" id="ticketAmount">0đ</span></div>
      <div class="row"><span class="label">Combo:</span><span class="value" id="comboAmount">0đ</span></div>
      <hr class="divider" />

      <div class="total-row">
        <span>TỔNG TIỀN:</span><span id="grandTotal">0đ</span>
      </div>
    </div>

    <button class="btn" id="btnPay">XÁC NHẬN THANH TOÁN</button>
    <div class="success-msg" id="successMsg">✅ THANH TOÁN THÀNH CÔNG!</div>
  </div>

  <script>
    // ============================================
    // CẤU HÌNH (QUAN TRỌNG: CHECK IP MÁY BẠN)
    // ============================================
    const SERVER_IP = "10.247.24.10"; // <--- Thay đúng IP máy tính của bạn
    const SERVER_PORT = "8080";
    const API_BASE = `http://${SERVER_IP}:${SERVER_PORT}/api`; 

    // Hàm debug ra màn hình điện thoại
    function log(msg, type='info') {
        const box = document.getElementById('debug-box');
        if(type === 'err') {
            box.style.display = 'block'; // Hiện box nếu có lỗi
            const p = document.createElement('div');
            p.className = 'log-err';
            p.textContent = "❌ " + msg;
            box.appendChild(p);
        }
        console.log(msg);
    }
    
    // Bắt lỗi toàn cục
    window.onerror = function(msg) { log(msg, 'err'); };

    // Format tiền VNĐ
    const toVND = (x) => (Number(x) || 0).toLocaleString("vi-VN") + "đ";
    const $ = (id) => document.getElementById(id);

    // Lấy transactionId từ URL
    const urlParams = new URLSearchParams(window.location.search);
    const transId = urlParams.get("trans");

    async function init() {
        if (!transId) {
            log("Thiếu mã giao dịch (transId) trên URL!", 'err');
            alert("Lỗi: Link không hợp lệ.");
            return;
        }

        // Gọi API lấy thông tin đơn hàng
        const url = `${API_BASE}/checkout/order?trans=${transId}`;
        log("Đang gọi API: " + url);

        try {
            const res = await fetch(url).catch(e => {
                throw new Error("Không thể kết nối đến " + SERVER_IP);
            });

            if (!res.ok) throw new Error(`Lỗi Server (${res.status})`);

            const data = await res.json();
            fillUI(data);

        } catch (e) {
            log(e.message, 'err');
            $('movieTitle').textContent = "Lỗi kết nối!";
            alert("Lỗi tải trang: " + e.message);
        }
    }

    function fillUI(data) {
        try {
            // 1. Điền thông tin cơ bản
            $('orderId').textContent = data.orderId || '...';
            
            // 2. Lấy thông tin từ object 'ticket' (Backend trả về cấu trúc này)
            const t = data.ticket || {};
            $('movieTitle').textContent = t.movieTitle || '...';
            $('theaterName').textContent = t.theaterName || '...';
            $('showDate').textContent = t.date || '--';
            $('showTime').textContent = t.time || '--';
            
            const seats = t.seats || [];
            $('seatList').textContent = seats.length > 0 ? seats.join(", ") : "...";

            // 3. Lấy thông tin tiền từ object 'totals'
            const m = data.totals || {};
            $('ticketAmount').textContent = toVND(m.ticketAmount);
            $('comboAmount').textContent = toVND(m.combosAmount);
            // $('discount').textContent = toVND(m.discountAmount || 0);
            $('grandTotal').textContent = toVND(m.grandTotal);

            // Gắn sự kiện nút bấm
            $('btnPay').onclick = handlePayment;

        } catch (e) {
            log("Lỗi hiển thị dữ liệu: " + e.message, 'err');
        }
    }

    async function handlePayment() {
        const btn = $('btnPay');
        btn.disabled = true;
        btn.textContent = "ĐANG XỬ LÝ...";

        try {
            const url = `${API_BASE}/checkout/mark-paid?trans=${transId}`;
            const res = await fetch(url, { method: "POST" });

            if (res.ok) {
                // Thành công
                $('mainContent').innerHTML = `
                    <div style="text-align:center; padding:40px;">
                        <h1 style="color:#4caf50; font-size:40px;">✔</h1>
                        <h2 style="color:#fff;">THANH TOÁN THÀNH CÔNG!</h2>
                        <p style="color:#aaa;">Bạn có thể đóng trình duyệt này.</p>
                    </div>
                `;
            } else {
                throw new Error("Server từ chối xác nhận.");
            }
        } catch (e) {
            log(e.message, 'err');
            alert("Thanh toán thất bại: " + e.message);
            btn.disabled = false;
            btn.textContent = "THỬ LẠI";
        }
    }

    // Chạy ngay khi tải trang
    init();
  </script>
</body>
</html>